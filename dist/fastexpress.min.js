!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("ramda"),require("moment"),require("bcrypt"),require("jsonwebtoken"),require("sequelize")):"function"==typeof define&&define.amd?define(["exports","ramda","moment","bcrypt","jsonwebtoken","sequelize"],t):t(e.fastexpress={},e.R,e.Moment,e.bcrypt,e.jwt,e.sequelize)}(this,function(e,t,r,a,o,s){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a,o=o&&o.hasOwnProperty("default")?o.default:o;const n=async(e,t,r)=>{try{t.json(await r(e))}catch(e){t.status(500).json({error:e.message})}};var i={list:n,create:n,get:async(e,t,r)=>{try{t.json(await r(e))}catch(e){"not found"===e.message?t.status(404).send(e.message):t.status(500).send(e)}},update:n,destroy:async(e,t,r)=>{try{await r(e),t.status(204).send()}catch(e){t.status(500).send(e)}}};const d=["create","get","list","destroy","update"],{table:l}=require("./create");module.exports={dropTable:e=>t=>t.dropTable(e),createTable:(e,t,r=(()=>{}))=>(a,o)=>a.createTable(e,{...l(o,{...t(o)})}).then(()=>r(a,o)),addConstraint:(e,t,{tableName:r,field:a,name:o})=>e.addConstraint(t,[a],{type:"foreign key",name:o,references:{table:r,field:"id"},onDelete:"cascade",onUpdate:"no action"})};var c=Object.freeze({});const u=e=>({id:{allowNull:!1,autoIncrement:!0,primaryKey:!0,type:e.INTEGER}}),p=e=>({createdAt:{allowNull:!1,type:e.DATE},updatedAt:{allowNull:!1,type:e.DATE}});module.exports={id:u,timestamp:p,table:(e,t={})=>({...u(e),...t,...p(e)})};var f=Object.freeze({});const y=(e,t,r)=>{const a=((e,t)=>Math.ceil(e/t))(e,r);return{totalItems:e,currentPage:t,perPage:r,totalPages:a,nextPage:((e,t)=>t>e?e+1:null)(t,a),previousPage:(e=>e>1?e-1:null)(t)}},m=(e,t={})=>{const r={};return Object.keys(e).forEach(a=>{void 0!==t[a]&&e[a].validation(t[a])?r[a]=void 0!==e[a].convert?e[a].convert(t[a],a):t[a]:void 0!==e[a].default&&(r[a]=e[a].default)}),r},h=t.compose(Boolean,t.length),b=e=>Number.isInteger(parseInt(e,10));var w=Object.freeze({string:h,number:b,float:e=>!Number.isNaN(parseFloat(e)),bool:e=>"boolean"==typeof!!e});const g=e=>{return e.split(",").map(e=>e.split("."))};var v=Object.freeze({orderToFilter:g,default:g});const $={validation:b},O={validation:h,convert:g,default:[["id","DESC"]]},E={validation:h},j={...$,default:100},q={...$,default:1},P={where:{},filter:null,aliasDatabase:{}},N=(e,t)=>r=>{const a=Object.keys(e);if(a.includes(r)){const o=a[a.indexOf(r)];return{model:t[e[o]],as:r}}return{model:t[r]}};var k={list:async({query:e},t,{options:r,database:a})=>{const{filters:o,aliasDatabase:s}={...P,...r};let n={};const{limit:i,page:d,batch:l,order:c}=m({limit:j,page:q,batch:E,order:O,...o},e),u={limit:i,offset:parseInt(i,10)*(d-1),order:c};if(o&&(n=m(o,e),u.where=n),l){let e=l.split(",");e=e.map(N(s,a)),u.include=e}try{const e=await t.findAll(u),{count:r}=await t.findAndCountAll({where:n}),a=y(r,d,i);return{data:JSON.parse(JSON.stringify(e)),pagination:a}}catch(e){throw console.error(e),Error("not found")}},create:async({body:e},t,{definitions:r})=>{const a=m(r,e);try{return await t.create(a)}catch(e){throw e}},get:async(e,t)=>{const{id:r}=e.params;try{const e=await t.findById(r);if(!e)throw Error("not found");return e}catch(e){throw Error("not found")}},update:async({params:e,body:t},r,{definitions:a})=>{const{id:o}=e,s=m(a,t);try{const e=await r.findById(o);if(!e)throw Error("not found");return await e.update(s)}catch(e){if("not found"===e.message)throw Error("not found");throw Error("unprocessable entity")}},destroy:async(e,t)=>{const{id:r}=e.params;try{return await t.destroy({where:{id:r}}),!0}catch(e){throw Error("unprocessable entity")}}};const A=(e,{router:t,middleware:r,controller:a})=>{t.get(`${e}/`,r,a.list),t.post(`${e}/`,r,a.create),t.get(`${e}/:id`,r,a.get),t.delete(`${e}/:id`,r,a.destroy),t.put(`${e}/:id`,r,a.update)},I=e=>`/${e}`,x={validation:()=>!0,convert:e=>{if(e.indexOf(",")>-1){const t=e.split(","),[r,a]=t;return{[s.Op.gte]:r,[s.Op.lte]:a}}return e}};e.createMiddleware=(e=>[(e=>(t,r,a)=>{const s=(e=>void 0!==e.body.token?e.body.token:void 0!==e.query.token?e.query.token:void 0!==e.headers.authorization?e.headers.authorization.replace("Bearer ",""):null)(t);s?o.verify(s,e,(e,t)=>{e?r.status(500).send({message:"Invalid auth token provided."}):(r.user=t,a())}):r.status(403).send({message:"No token provided"})})(e),(e,t,r)=>{let a="UserId";"/api/v1/users/"===e.route.path&&(a="id"),e.query={...e.query,[a]:t.user.id},e.body={...e.body,[a]:t.user.id},r()}]),e.Controller=i,e.dateFilter=x,e.orderToFilter=g,e.cryptPassword=(e=>t=>t.password!==t._previousDataValues.password?a.hash(t.password,a.genSaltSync(e)).then(e=>{t.password=e}):null),e.getModelAlias=N,e.paginationParse=y,e.resources=((e,{router:t,controller:r})=>{t.get(`${e}/`,r.list),t.post(`${e}/`,r.create),t.get(`${e}/:id`,r.get),t.delete(`${e}/:id`,r.destroy),t.put(`${e}/:id`,r.update)}),e.resourcesAuth=A,e.namespaceCreator=((e="/")=>(t="")=>`${e}${t}`),e.namespaceIndexCreator=(e=>t=>e().split("/").filter(e=>!!e).reduceRight((e,t)=>({[t]:e}),t)),e.resourceList=((e,{custom:t=[],namespace:r=I}={})=>[...[e=>`[get] ${e}`,e=>`[post] ${e}`,e=>`[get] ${e}/:id`,e=>`[delete] ${e}/:id`,e=>`[put] ${e}/:id`].map(t=>t(r(e))),...t]),e.resourceWithAuth=((e,t,{router:r,middleware:a,namespace:o=I})=>A(o(e),{controller:t,router:r,middleware:a})),e.selector=m,e.validate=w,e.convert=v,e.Service=k,e.createController=((e,{only:t=d,custom:r={}}={})=>{const a={};return t.forEach(t=>{a[t]=((r,a)=>i[t](r,a,e[t]))}),{...a,...r}}),e.createService=((e,{only:t=d,definitions:r={},options:a={},custom:o={},database:s})=>{const n={};return t.forEach(t=>{n[t]=(o=>k[t](o,e,{definitions:r,options:a,database:s}))}),{...n,...o}}),e.serviceDefaultProps=(({form:e,filters:t,database:r})=>({definitions:e,options:{filters:t},database:r})),e.migrationActions=c,e.migrationHelper=f,Object.defineProperty(e,"__esModule",{value:!0})});
