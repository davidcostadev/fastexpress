!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("ramda"),require("moment"),require("bcrypt"),require("jsonwebtoken"),require("sequelize")):"function"==typeof define&&define.amd?define(["exports","ramda","moment","bcrypt","jsonwebtoken","sequelize"],t):t(e.fastexpress={},e.R,e.Moment,e.bcrypt,e.jwt,e.sequelize)}(this,function(e,t,r,a,o,s){"use strict";var n="default"in t?t.default:t;r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a,o=o&&o.hasOwnProperty("default")?o.default:o;const i=async(e,t,r)=>{try{t.json(await r(e))}catch(e){t.status(500).json({error:e.message})}};var d={list:i,create:i,get:async(e,t,r)=>{try{t.json(await r(e))}catch(e){"not found"===e.message?t.status(404).send(e.message):t.status(500).send(e)}},update:i,destroy:async(e,t,r)=>{try{await r(e),t.status(204).send()}catch(e){t.status(500).send(e)}}};const l=["create","get","list","destroy","update"],{table:c}=require("./create");module.exports={dropTable:e=>t=>t.dropTable(e),createTable:(e,t,r=(()=>{}))=>(a,o)=>a.createTable(e,{...c(o,{...t(o)})}).then(()=>r(a,o)),addConstraint:(e,t,{tableName:r,field:a,name:o})=>e.addConstraint(t,[a],{type:"foreign key",name:o,references:{table:r,field:"id"},onDelete:"cascade",onUpdate:"no action"})};var u=Object.freeze({});const p=e=>({id:{allowNull:!1,autoIncrement:!0,primaryKey:!0,type:e.INTEGER}}),f=e=>({createdAt:{allowNull:!1,type:e.DATE},updatedAt:{allowNull:!1,type:e.DATE}});module.exports={id:p,timestamp:f,table:(e,t={})=>({...p(e),...t,...f(e)})};var y=Object.freeze({});const m=(e,t,r)=>{const a=((e,t)=>Math.ceil(e/t))(e,r);return{totalItems:e,currentPage:t,perPage:r,totalPages:a,nextPage:((e,t)=>t>e?e+1:null)(t,a),previousPage:(e=>e>1?e-1:null)(t)}},h=(e,t={})=>{const r={};return Object.keys(e).forEach(a=>{void 0!==t[a]&&e[a].validation(t[a])?r[a]=void 0!==e[a].convert?e[a].convert(t[a],a):t[a]:void 0!==e[a].default&&(r[a]=e[a].default)}),r},b=n.compose(Boolean,n.length),w=e=>Number.isInteger(parseInt(e,10));var g=Object.freeze({string:b,number:w,float:e=>!Number.isNaN(parseFloat(e)),bool:e=>"boolean"==typeof!!e});const v=e=>{return e.split(",").map(e=>e.split("."))};var O=Object.freeze({orderToFilter:v,default:v});const $={validation:w},q={validation:b,convert:v,default:[["id","DESC"]]},j={validation:b},E={...$,default:100},N={...$,default:1},k={where:{},filter:null,aliasDatabase:{}},P=(e,t)=>r=>{const a=Object.keys(e);if(a.includes(r)){const o=a[a.indexOf(r)];return{model:t[e[o]],as:r}}return{model:t[r]}},A=({query:e},{options:t,database:r})=>(a={})=>{const{aliasDatabase:o}={...k,...t},{batch:s}=h({batch:j},e);if(s){let e=s.split(",");e=e.map(P(o,r)),a.include=e}return a};var x={list:async(e,r,a)=>{const{limit:o,page:s}=h({limit:E,page:N},e.query),n=t.compose((({query:e},t)=>(t={})=>{const{limit:r,page:a,order:o}=h({limit:E,page:N,order:q},e);return{...t,limit:r,offset:parseInt(r,10)*(a-1),order:o}})(e),A(e,a),(({query:e},{options:t})=>(r={})=>{const{filters:a}={...k,...t};return a&&(r.where=h(a,e)),r})(e,a))(),i=n.where?n.where:{};try{const e=await r.findAll(n),{count:t}=await r.findAndCountAll({where:i}),a=m(t,s,o);return{data:JSON.parse(JSON.stringify(e)),pagination:a}}catch(e){throw console.error(e),Error("not found")}},create:async({body:e},t,{definitions:r})=>{const a=h(r,e);try{return await t.create(a)}catch(e){throw e}},get:async(e,t,r)=>{const{id:a}=e.params,o=A(e,r)({where:{id:a}});try{const e=await t.findOne(o);if(!e)throw Error("not found");return JSON.parse(JSON.stringify(e))}catch(e){throw console.error(e),Error("not found")}},update:async({params:e,body:t},r,{definitions:a})=>{const{id:o}=e,s=h(a,t);try{const e=await r.findById(o);if(!e)throw Error("not found");return await e.update(s)}catch(e){if("not found"===e.message)throw Error("not found");throw Error("unprocessable entity")}},destroy:async(e,t)=>{const{id:r}=e.params;try{return await t.destroy({where:{id:r}}),!0}catch(e){throw Error("unprocessable entity")}}};const I=(e,{router:t,middleware:r,controller:a})=>{t.get(`${e}/`,r,a.list),t.post(`${e}/`,r,a.create),t.get(`${e}/:id`,r,a.get),t.delete(`${e}/:id`,r,a.destroy),t.put(`${e}/:id`,r,a.update)},z=e=>`/${e}`,S={validation:()=>!0,convert:e=>{if(e.indexOf(",")>-1){const t=e.split(","),[r,a]=t;return{[s.Op.gte]:r,[s.Op.lte]:a}}return e}};e.createMiddleware=(e=>[(e=>(t,r,a)=>{const s=(e=>void 0!==e.body.token?e.body.token:void 0!==e.query.token?e.query.token:void 0!==e.headers.authorization?e.headers.authorization.replace("Bearer ",""):null)(t);s?o.verify(s,e,(e,t)=>{e?r.status(500).send({message:"Invalid auth token provided."}):(r.user=t,a())}):r.status(403).send({message:"No token provided"})})(e),(e,t,r)=>{let a="UserId";"/api/v1/users/"===e.route.path&&(a="id"),e.query={...e.query,[a]:t.user.id},e.body={...e.body,[a]:t.user.id},r()}]),e.Controller=d,e.dateFilter=S,e.orderToFilter=v,e.cryptPassword=(e=>t=>t.password!==t._previousDataValues.password?a.hash(t.password,a.genSaltSync(e)).then(e=>{t.password=e}):null),e.getModelAlias=P,e.paginationParse=m,e.resources=((e,{router:t,controller:r})=>{t.get(`${e}/`,r.list),t.post(`${e}/`,r.create),t.get(`${e}/:id`,r.get),t.delete(`${e}/:id`,r.destroy),t.put(`${e}/:id`,r.update)}),e.resourcesAuth=I,e.namespaceCreator=((e="/")=>(t="")=>`${e}${t}`),e.namespaceIndexCreator=(e=>t=>e().split("/").filter(e=>!!e).reduceRight((e,t)=>({[t]:e}),t)),e.resourceList=((e,{custom:t=[],namespace:r=z}={})=>[...[e=>`[get] ${e}`,e=>`[post] ${e}`,e=>`[get] ${e}/:id`,e=>`[delete] ${e}/:id`,e=>`[put] ${e}/:id`].map(t=>t(r(e))),...t]),e.resourceWithAuth=((e,t,{router:r,middleware:a,namespace:o=z})=>I(o(e),{controller:t,router:r,middleware:a})),e.selector=h,e.validate=g,e.convert=O,e.Service=x,e.createController=((e,{only:t=l,custom:r={}}={})=>{const a={};return t.forEach(t=>{a[t]=((r,a)=>d[t](r,a,e[t]))}),{...a,...r}}),e.createService=((e,{only:t=l,definitions:r={},options:a={},custom:o={},database:s})=>{const n={definitions:r,options:a,database:s},i=t.reduce((e,t)=>(e[t]=x[t],e),o);return Object.keys(i).map(t=>({[t]:r=>i[t](r,e,n)})).reduce((e,t)=>Object.assign(e,t),{})}),e.serviceDefaultProps=(({form:e,filters:t,database:r})=>({definitions:e,options:{filters:t},database:r,custom:custom})),e.migrationActions=u,e.migrationHelper=y,Object.defineProperty(e,"__esModule",{value:!0})});
