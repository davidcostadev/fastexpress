!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("ramda"),require("moment"),require("bcrypt"),require("jsonwebtoken"),require("sequelize")):"function"==typeof define&&define.amd?define(["exports","ramda","moment","bcrypt","jsonwebtoken","sequelize"],t):t((e=e||self).fastexpress={},e.R,e.Moment,e.bcrypt,e.jwt,e.sequelize)}(this,function(e,t,r,a,o,n){"use strict";var s="default"in t?t.default:t;r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a,o=o&&o.hasOwnProperty("default")?o.default:o;const i=async(e,t,r)=>{try{t.json(await r(e))}catch(e){t.status(500).json({error:e.message})}};var d={list:i,create:i,get:async(e,t,r)=>{try{t.json(await r(e))}catch(e){"not found"===e.message?t.status(404).send(e.message):t.status(500).send(e)}},update:i,destroy:async(e,t,r)=>{try{await r(e),t.status(204).send()}catch(e){t.status(500).send(e)}}};const l=["create","get","list","destroy","update"],{table:c}=require("./create");module.exports={dropTable:e=>t=>t.dropTable(e),createTable:(e,t,r=(()=>{}))=>(a,o)=>a.createTable(e,{...c(o,{...t(o)})}).then(()=>r(a,o)),addConstraint:(e,t,{tableName:r,field:a,name:o})=>e.addConstraint(t,[a],{type:"foreign key",name:o,references:{table:r,field:"id"},onDelete:"cascade",onUpdate:"no action"})};var u=Object.freeze({});const p=e=>({id:{allowNull:!1,autoIncrement:!0,primaryKey:!0,type:e.INTEGER}}),f=e=>({createdAt:{allowNull:!1,type:e.DATE},updatedAt:{allowNull:!1,type:e.DATE}});module.exports={id:p,timestamp:f,table:(e,t={})=>({...p(e),...t,...f(e)})};var y=Object.freeze({});const m=(e,t)=>t>e?e+1:null,b=e=>e>1?e-1:null,h=(e,t,r)=>{const a=((e,t)=>Math.ceil(e/t))(e,r);return{totalItems:e,currentPage:t,perPage:r,totalPages:a,nextPage:m(t,a),previousPage:b(t)}},g=(e,t={})=>{const r={};return Object.keys(e).forEach(a=>{void 0!==t[a]&&e[a].validation(t[a])?r[a]=void 0!==e[a].convert?e[a].convert(t[a],a):t[a]:void 0!==e[a].default&&(r[a]=e[a].default)}),r},w=s.compose(Boolean,s.length),v=e=>Number.isInteger(parseInt(e,10)),O=e=>!Number.isNaN(parseFloat(e)),T=e=>"boolean"==typeof!!e;var $=Object.freeze({string:w,number:v,float:O,bool:T});const j=e=>{return e.split(",").map(e=>e.split("."))};var q=Object.freeze({orderToFilter:j,default:j});const E={validation:w},N={validation:v},k={validation:O,convert:e=>"string"==typeof e?e.replace(",","."):e},P={validation:T},S={validation:w},A={validation:w,convert:e=>r(e).format("YYYY-MM-DD")},x={validation:w,convert:j,default:[["id","DESC"]]},z=E,D={...N,default:100},I={...N,default:1};var C=Object.freeze({stringType:E,numberType:N,floatType:k,boolType:P,datetimeType:S,dateType:A,orderType:x,batchSelType:z,limitSelType:D,pageSelType:I});const M={where:{},filter:null,aliasDatabase:{}},F=(e,t)=>r=>{const a=Object.keys(e);if(a.includes(r)){const o=a[a.indexOf(r)];return{model:t[e[o]],as:r}}return{model:t[r]}},J=({query:e},{options:t,database:r})=>(a={})=>{const{aliasDatabase:o}={...M,...t},{batch:n}=g({batch:z},e);if(n){let e=n.split(",");e=e.map(F(o,r)),a.include=e}return a};var Y={list:async(e,r,a)=>{const{limit:o,page:n}=g({limit:D,page:I},e.query),s=t.compose((({query:e})=>(t={})=>{const{limit:r,page:a,order:o}=g({limit:D,page:I,order:x},e);return{...t,limit:r,offset:parseInt(r,10)*(a-1),order:o}})(e),J(e,a),(({query:e},{options:t})=>(r={})=>{const{filters:a}={...M,...t};return a&&(r.where=g(a,e)),r})(e,a))(),i=s.where?s.where:{};try{const e=await r.findAll(s),{count:t}=await r.findAndCountAll({where:i}),a=h(t,n,o);return{data:JSON.parse(JSON.stringify(e)),pagination:a}}catch(e){throw console.error(e),Error("not found")}},create:async({body:e},t,{definitions:r})=>{const a=g(r,e);try{return await t.create(a)}catch(e){throw e}},get:async(e,t,r)=>{const{id:a}=e.params,o=J(e,r)({where:{id:a}});try{const e=await t.findOne(o);if(!e)throw Error("not found");return JSON.parse(JSON.stringify(e))}catch(e){throw console.error(e),Error("not found")}},update:async({params:e,body:t},r,{definitions:a})=>{const{id:o}=e,n=g(a,t);try{const e=await r.findById(o);if(!e)throw Error("not found");return await e.update(n)}catch(e){if("not found"===e.message)throw Error("not found");throw Error("unprocessable entity")}},destroy:async(e,t)=>{const{id:r}=e.params;try{return await t.destroy({where:{id:r}}),!0}catch(e){throw Error("unprocessable entity")}}};const B=(e,{router:t,middleware:r,controller:a})=>{t.get(`${e}/`,r,a.list),t.post(`${e}/`,r,a.create),t.get(`${e}/:id`,r,a.get),t.delete(`${e}/:id`,r,a.destroy),t.put(`${e}/:id`,r,a.update)},R=e=>`/${e}`,_=e=>(t,r,a)=>{const n=(e=>void 0!==e.body.token?e.body.token:void 0!==e.query.token?e.query.token:void 0!==e.headers.authorization?e.headers.authorization.replace("Bearer ",""):null)(t);n?o.verify(n,e,(e,t)=>{e?r.status(500).send({message:"Invalid auth token provided."}):(r.user=t,a())}):r.status(403).send({message:"No token provided"})},U=(e,t,r)=>{let a="UserId";"/api/v1/users/"===e.route.path&&(a="id"),e.query={...e.query,[a]:t.user.id},e.body={...e.body,[a]:t.user.id},r()},G={validation:()=>!0,convert:e=>{if(e.indexOf(",")>-1){const t=e.split(","),[r,a]=t;return{[n.Op.gte]:r,[n.Op.lte]:a}}return e}};e.Controller=d,e.Service=Y,e.convert=q,e.createController=((e,{only:t=l,custom:r={}}={})=>{const a={};return t.forEach(t=>{a[t]=((r,a)=>d[t](r,a,e[t]))}),{...a,...r}}),e.createMiddleware=(e=>[_(e),U]),e.createService=((e,{only:t=l,definitions:r={},options:a={},custom:o={},database:n})=>{const s={definitions:r,options:a,database:n},i=t.reduce((e,t)=>({...e,[t]:Y[t]}),o);return Object.keys(i).map(t=>({[t]:r=>i[t](r,e,s)})).reduce((e,t)=>Object.assign(e,t),{})}),e.cryptPassword=(e=>t=>t.password!==t._previousDataValues.password?a.hash(t.password,a.genSaltSync(e)).then(e=>{t.password=e}):null),e.dateFilter=G,e.getModelAlias=F,e.migrationActions=u,e.migrationHelper=y,e.namespaceCreator=((e="/")=>(t="")=>`${e}${t}`),e.namespaceIndexCreator=(e=>t=>e().split("/").filter(e=>!!e).reduceRight((e,t)=>({[t]:e}),t)),e.orderToFilter=j,e.paginationParse=h,e.resourceList=((e,{custom:t=[],namespace:r=R}={})=>[...[e=>`[get] ${e}`,e=>`[post] ${e}`,e=>`[get] ${e}/:id`,e=>`[delete] ${e}/:id`,e=>`[put] ${e}/:id`].map(t=>t(r(e))),...t]),e.resourceWithAuth=((e,t,{router:r,middleware:a,namespace:o=R})=>B(o(e),{controller:t,router:r,middleware:a})),e.resources=((e,{router:t,controller:r})=>{t.get(`${e}/`,r.list),t.post(`${e}/`,r.create),t.get(`${e}/:id`,r.get),t.delete(`${e}/:id`,r.destroy),t.put(`${e}/:id`,r.update)}),e.resourcesAuth=B,e.selector=g,e.serviceDefaultProps=(({form:e,filters:t,database:r})=>({definitions:e,options:{filters:t},database:r})),e.type=C,e.validate=$,Object.defineProperty(e,"__esModule",{value:!0})});
